datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?     // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'hobby', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(3)

  // GDPR compliance - account deletion
  scheduledForDeletion      Boolean         @default(false)
  deletionDate              DateTime?

  contactFormMessages       ContactFormMessage[]
  files                     File[]
  testSessions              TestSession[]
}

model TestSession {
  id                   String   @id @default(uuid())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user                 User?    @relation(fields: [userId], references: [id])
  userId               String?

  // Progress tracking
  currentQuestionIndex Int      @default(0)
  isCompleted          Boolean  @default(false)
  
  // Payment gate
  isPaid               Boolean  @default(false)
  email                String?  // Lead capture before matching with User

  // User Profile Data (Collected before test)
  userGender           String?
  partnerGender        String?
  userAgeRange         String?
  partnerAgeRange      String?
  relationshipStatus   String?

  // Answers stored as JSON for flexibility (mapped by question ID)
  // Format: { [questionId: number]: { answerId: number, score: number, type: "PM" | "SL" } }
  answers              Json     @default("{}")
  
  // Calculated Scores (optional, populated after completion)
  scores               Json?    

  // NEW: Input for "The Fight Decoder"
  conflictDescription  String?
  
  // NEW: Persisted AI Analysis
  executiveAnalysis    String?

  // Meta CAPI Cookies tracking
  fbp                  String?
  fbc                  String?

  // Onboarding tracking
  onboardingCompleted    Boolean   @default(false)
  onboardingStep         Int       @default(0)
  onboardingCompletedAt  DateTime?
  savedScriptsToPhone    Boolean   @default(false)
  downloadedFridgeSheet  Boolean   @default(false)
  triedTranslatorTool    Boolean   @default(false)

  // Relationship history (for hyper-personalized AI)
  relationshipDuration    String?
  livingTogether          Boolean?
  hasChildren             Boolean?
  previousRelationships   String?
  previousMarriage        Boolean?
  majorLifeTransition     String?

  // Partner behavior (for compatibility score)
  partnerConflictStyle    String?  // "withdraws" | "engages" | "escalates"
  fightFrequency          String?  // "daily" | "weekly" | "monthly" | "rarely"
  repairFrequency         String?  // "always" | "sometimes" | "rarely" | "never"
  partnerHurtfulBehavior  String?  // open-ended description

  // Retention Email Tracking
  emailSequenceType        String?   // "test_abandonment" | "teaser_viewer" | "checkout_abandonment"
  retentionEmailStage      Int       @default(0)
  lastRetentionEmailSentAt DateTime?
  emailSentHistory         Json      @default("[]") // Array of {stage, sentAt, opened, clicked}
  
  // Unsubscribe tracking
  unsubscribedFromEmails   Boolean   @default(false)
  unsubscribedAt           DateTime?
  
  // Checkout tracking
  stripeCheckoutSessionId  String?
  checkoutStartedAt        DateTime?
  checkoutAbandonedAt      DateTime?
  
  // Personalization cache (pre-computed variables for emails)
  personalizationData      Json?

  // Archive status for data retention policy
  isArchived               Boolean   @default(false)
}


model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  s3Key                     String
}

model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

model MagicLinkToken {
  id        String   @id @default(uuid())
  token     String   @unique
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
}
